<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„±ê²½ê²€ìƒ‰ê¸°</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#5c6bc0">
    <link rel="apple-touch-icon" href="icon.png">

    <script>
        // ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ (ì•± ì„¤ì¹˜ ê¸°ëŠ¥ í™œì„±í™”)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker ë“±ë¡ ì„±ê³µ:', reg.scope))
                    .catch(err => console.log('Service Worker ë“±ë¡ ì‹¤íŒ¨:', err));
            });
        }
    </script>

    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Roboto:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        /* --- [ìŠ¤íƒ€ì¼] --- */
        body { 
            font-family: 'Roboto', 'Noto Sans KR', sans-serif;
            background-color: #f0f2f5; 
            display: flex; 
            justify-content: center; 
            padding: 40px 20px;
            margin: 0;
            color: #333;
        }
        .container { 
            width: 100%; 
            max-width: 700px; 
            background: white; 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            position: relative; 
        }
        h1 { 
            text-align: center; color: #2c3e50; margin: 0 0 25px 0; 
            font-size: 22px; font-weight: 700; line-height: 1.4;
        }

        .help-btn {
            position: absolute; top: 20px; right: 20px; width: 30px; height: 30px;
            background-color: #90a4ae; color: white; border-radius: 50%; border: none;
            font-weight: bold; font-size: 18px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .help-btn:hover { background-color: #607d8b; }

        .search-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        select, input, button { 
            padding: 12px; border-radius: 8px; border: 1px solid #ddd; 
            font-size: 16px; outline: none; -webkit-appearance: none; 
            font-family: 'Roboto', 'Noto Sans KR', sans-serif;
        }
        select { background-color: #fff; min-width: 100px; }
        input { flex: 1; }
        
        .search-btn { 
            background-color: #5c6bc0; color: white; border: none; 
            cursor: pointer; font-weight: bold; min-width: 80px;
        }
        .search-btn:active { background-color: #3f51b5; }

        .count-display { margin-bottom: 15px; color: #666; font-size: 14px; text-align: right; }
        .highlight { color: #e74c3c; font-weight: bold; }
        .loading { text-align: center; color: #888; margin: 20px 0; font-size: 14px; }
        .result-item { border-bottom: 1px solid #f1f1f1; padding: 20px 0; }
        .result-item:last-child { border-bottom: none; }
        .result-item h3 { 
            margin: 0 0 10px; font-size: 17px; color: #2c3e50; 
            background-color: #f5f7fa; display: inline-block; 
            padding: 5px 10px; border-radius: 6px; font-weight: 700;
        }
        .verse-box { display: grid; gap: 6px; }
        .verse-text { 
            margin: 0; line-height: 1.6; padding-left: 10px; 
            border-left: 3px solid transparent; font-size: 16px; word-break: keep-all; 
        }
        
        /* ì–¸ì–´ë³„ ìŠ¤íƒ€ì¼ */
        .kr { color: #333; border-left-color: #e74c3c; font-weight: 500; font-family: 'Noto Sans KR', sans-serif; }
        .ekr { color: #8e24aa; border-left-color: #8e24aa; font-weight: 500; font-family: 'Noto Sans KR', sans-serif; }
        .hr { color: #2e7d32; border-left-color: #2e7d32; font-style: italic; font-size: 15px; font-family: 'Roboto', sans-serif; }
        .en { color: #1976d2; border-left-color: #1976d2; font-size: 15px; font-family: 'Roboto', sans-serif; }

        /* â˜… ê²€ìƒ‰ì–´ í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ (ì§„í•˜ê²Œ + ë…¸ë€ í˜•ê´‘íœ) â˜… */
        .keyword-highlight {
            font-weight: 900;
            background-color: #fff59d; /* ì—°í•œ ë…¸ë‘ ë°°ê²½ */
            color: #d81b60; /* ì§„í•œ í•‘í¬ìƒ‰ ê¸€ì”¨ */
            border-radius: 2px;
            padding: 0 2px;
        }

        .pagination { display: flex; justify-content: center; gap: 4px; margin-top: 30px; flex-wrap: wrap; }
        .page-btn {
            padding: 8px 12px; border: 1px solid #eee; background-color: white; 
            color: #555; cursor: pointer; border-radius: 4px; font-size: 14px; 
            font-family: 'Roboto', sans-serif;
        }
        .page-btn.active { background-color: #5c6bc0; color: white; border-color: #5c6bc0; }
        
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 1000;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: white; padding: 25px; border-radius: 12px;
            width: 90%; max-width: 500px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
        }
        .modal-close {
            position: absolute; top: 15px; right: 15px;
            font-size: 24px; cursor: pointer; color: #888;
            background: none; border: none; padding: 0;
        }
        .help-list li { margin-bottom: 10px; line-height: 1.5; }
        .help-code { 
            background-color: #f1f1f1; padding: 2px 6px; 
            border-radius: 4px; font-family: monospace; color: #d81b60;
        }

        @media (max-width: 600px) {
            body { padding: 10px; background-color: #fff; }
            .container { padding: 15px; box-shadow: none; }
            h1 { font-size: 18px; margin-bottom: 20px; word-break: keep-all; }
            .search-controls { flex-direction: column; gap: 8px; }
            select, input, .search-btn { width: 100%; height: 48px; font-size: 16px; }
            .verse-text { font-size: 16px; padding-left: 8px; }
            .result-item { padding: 15px 0; }
        }
    </style>
</head>
<body>

<div class="container">
    <button class="help-btn" onclick="openModal()">?</button>

    <h1>ğŸ“– ì„±ê²½ ê²€ìƒ‰ (ê°œì—­ê°œì •, ì‰¬ìš´ì„±ê²½, í¬ë¡œì•„í‹°ì•„ì–´, NIV)</h1>
    
    <div class="search-controls">
        <select id="searchLang">
            <option value="kr">ê°œì—­ê°œì • (KR)</option>
            <option value="ekr">ì‰¬ìš´ì„±ê²½ (Easy)</option>
            <option value="hr">í¬ë¡œì•„í‹°ì•„ì–´ (HR)</option>
            <option value="en">English (NIV)</option>
        </select>
        <input type="text" id="searchInput" placeholder="ì˜ˆ: ì‚¬ë‘, ë§ˆíƒœ 1:1, ë§ˆíƒœ 1:1-5">
        <button class="search-btn" onclick="searchBible()">ê²€ìƒ‰</button>
    </div>

    <div id="resultCount" class="count-display"></div>
    
    <div id="status" class="loading">
        ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...<br>
        (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”)
    </div>
    
    <div id="results"></div>
    <div id="pagination" class="pagination"></div>
</div>

<div id="helpModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModalButton()">Ã—</button>
        <h2 style="margin-top:0; color:#2c3e50;">ğŸ’¡ ê²€ìƒ‰ ë„ì›€ë§</h2>
        <ul class="help-list" style="padding-left: 20px; color:#555;">
            <li><b>ë‹¨ì–´ ê²€ìƒ‰:</b> <span class="help-code">ì‚¬ë‘</span>, <span class="help-code">ë¯¿ìŒ</span> ë“±ì„ ì…ë ¥í•˜ë©´ í•´ë‹¹ ë‹¨ì–´ê°€ ì§„í•˜ê²Œ í‘œì‹œë©ë‹ˆë‹¤.</li>
            <li><b>ì¥ ì „ì²´ ê²€ìƒ‰:</b> <span class="help-code">ë§ˆíƒœë³µìŒ 1</span> ë˜ëŠ” <span class="help-code">ë§ˆíƒœ 1:</span></li>
            <li><b>íŠ¹ì • ì ˆ ê²€ìƒ‰:</b> <span class="help-code">ìš”í•œ 3:16</span></li>
            <li><b>ë²”ìœ„ ê²€ìƒ‰:</b> <span class="help-code">ë¡œë§ˆì„œ 8:1-5</span></li>
        </ul>
        <p style="font-size:13px; color:#888; margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
            * ì‰¬ìš´ì„±ê²½ ë“± íŠ¹ì • ì–¸ì–´ë¥¼ ì„ íƒí•´ë„ ê²°ê³¼ì—ëŠ” 4ê°œ ì„±ê²½ì´ ëª¨ë‘ í•¨ê»˜ í‘œì‹œë©ë‹ˆë‹¤.
        </p>
    </div>
</div>

<script>
    let bibleData = [];
    let currentFilteredData = []; 
    let currentPage = 1;          
    const rowsPerPage = 10;
    let currentSearchKeyword = ""; // í˜„ì¬ ê²€ìƒ‰ì–´ë¥¼ ì €ì¥í•  ë³€ìˆ˜

    const DATA_URL = 'https://script.google.com/macros/s/AKfycbzjWeQCC7FkWRxfgvQepJOm-q1N12mRK0qSaPIu5jqVcz7xeS3G3I2REY6vQx_7eaQS/exec';

    fetch(DATA_URL)
    .then(response => response.json())
    .then(data => {
        bibleData = data;
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = "âœ… ì¤€ë¹„ ì™„ë£Œ!";
        setTimeout(() => { statusDiv.style.display = 'none'; }, 1000);
    })
    .catch(error => {
        console.error(error);
        document.getElementById('status').innerText = "âŒ ë°ì´í„° ì—°ê²° ì‹¤íŒ¨";
        document.getElementById('status').style.color = "red";
    });

    function searchBible() {
        const langMode = document.getElementById('searchLang').value;
        const input = document.getElementById('searchInput').value.toLowerCase().trim();
        
        if (input === "") { alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }
        if (bibleData.length === 0) { alert("ì•„ì§ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤."); return; }

        document.getElementById('searchInput').blur();
        
        // ê²€ìƒ‰ì–´ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (í•˜ì´ë¼ì´íŠ¸ ê¸°ëŠ¥ìš©)
        currentSearchKeyword = input;

        currentFilteredData = bibleData.filter(item => {
            let contentText = "";
            if (langMode === 'kr') contentText = item.content_kr;
            else if (langMode === 'ekr') contentText = item.content_ekr;
            else if (langMode === 'hr') contentText = item.content_hr;
            else if (langMode === 'en') contentText = item.content_en;
            
            if (!contentText) contentText = "";

            const bookName = item.book ? item.book.toLowerCase() : "";
            const verseRef = `${item.chapter}:${item.verse}`; 
            const itemChapter = parseInt(item.chapter);
            const itemVerse = parseInt(item.verse);

            const basicMatch = contentText.toLowerCase().includes(input) || 
                               bookName.includes(input) || 
                               verseRef === input;

            let complexMatch = false;
            
            if (input.includes(' ')) {
                const lastSpaceIndex = input.lastIndexOf(' ');
                const searchBook = input.substring(0, lastSpaceIndex).trim();
                const searchRef = input.substring(lastSpaceIndex + 1).trim();

                if (bookName.includes(searchBook)) {
                    if (searchRef.endsWith(':')) {
                        const searchChapter = parseInt(searchRef.replace(':', ''));
                        if (itemChapter === searchChapter) complexMatch = true;
                    }
                    else if (searchRef.includes('-') && searchRef.includes(':')) {
                        try {
                            const parts = searchRef.split(':');
                            const searchChapter = parseInt(parts[0]);
                            const rangeParts = parts[1].split('-');
                            const startVerse = parseInt(rangeParts[0]);
                            const endVerse = parseInt(rangeParts[1]);
                            if (itemChapter === searchChapter && itemVerse >= startVerse && itemVerse <= endVerse) {
                                complexMatch = true;
                            }
                        } catch (e) {}
                    } 
                    else if (searchRef.includes(':')) {
                        if (verseRef === searchRef) complexMatch = true;
                    } 
                    else {
                        if (verseRef.startsWith(searchRef + ':')) complexMatch = true;
                    }
                }
            }
            return basicMatch || complexMatch;
        });

        currentPage = 1; 
        updateCountDisplay(); 
        displayList(); 
        setupPagination(); 
    }

    function updateCountDisplay() {
        const countDiv = document.getElementById('resultCount');
        if (currentFilteredData.length > 0) {
            countDiv.innerHTML = `ì´ <span class="highlight">${currentFilteredData.length}</span>êµ¬ì ˆ ë°œê²¬`;
        } else {
            countDiv.innerHTML = "";
        }
    }

    // â˜… ë‹¨ì–´ í•˜ì´ë¼ì´íŠ¸ í•¨ìˆ˜ â˜…
    function highlightText(text, keyword) {
        if (!text) return "";
        // ê²€ìƒ‰ì–´ê°€ ì—†ê±°ë‚˜ ë„ˆë¬´ ì§§ìœ¼ë©´(1ê¸€ì ë¯¸ë§Œ) í•˜ì´ë¼ì´íŠ¸ ì•ˆ í•¨
        if (!keyword || keyword.length < 1) return text;
        
        // ì •ê·œì‹ íŠ¹ìˆ˜ë¬¸ì ì˜¤ë¥˜ ë°©ì§€ (ê°„ë‹¨í•œ ì²˜ë¦¬)
        // ì‚¬ìš©ìê°€ 'ì‚¬ë‘'ì„ ì…ë ¥í•˜ë©´ ë³¸ë¬¸ì—ì„œ 'ì‚¬ë‘'ì„ ì°¾ì•„ <span> íƒœê·¸ë¡œ ê°ìŒˆ
        try {
            // "ì‚¬ë‘"ì„ ì°¾ë˜ ëŒ€ì†Œë¬¸ì ë¬´ì‹œ(gi)
            const regex = new RegExp(`(${keyword})`, 'gi');
            return text.replace(regex, '<span class="keyword-highlight">$1</span>');
        } catch (e) {
            return text; // ì—ëŸ¬ ë‚˜ë©´ ê·¸ëƒ¥ ì›ë³¸ í…ìŠ¤íŠ¸ ë¦¬í„´
        }
    }

    function displayList() {
        const resultContainer = document.getElementById('results');
        resultContainer.innerHTML = "";
        window.scrollTo({ top: 0, behavior: 'smooth' });

        if (currentFilteredData.length === 0) {
            resultContainer.innerHTML = '<div style="text-align:center; color:#888; padding:30px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedItems = currentFilteredData.slice(start, end);

        paginatedItems.forEach(item => {
            const div = document.createElement('div');
            div.className = 'result-item';
            
            // â˜… ì—¬ê¸°ì„œ í•˜ì´ë¼ì´íŠ¸ í•¨ìˆ˜ë¥¼ ì ìš©í•´ì„œ ì¶œë ¥í•©ë‹ˆë‹¤ â˜…
            // ê²€ìƒ‰ì–´ì— ê³µë°±ì´ ìˆìœ¼ë©´(ì˜ˆ: ë§ˆíƒœ 1:1) í•˜ì´ë¼ì´íŠ¸ ê¸°ëŠ¥ì´ í…ìŠ¤íŠ¸ë¥¼ ë§ì¹  ìˆ˜ ìˆìœ¼ë¯€ë¡œ,
            // ë‹¨ìˆœ ë‹¨ì–´ ê²€ìƒ‰ì¼ ë•Œë§Œ í•˜ì´ë¼ì´íŠ¸ ì ìš©í•˜ë„ë¡ ì¡°ê±´ ì¶”ê°€
            let highlightKeyword = "";
            if (!currentSearchKeyword.includes(' ') && !currentSearchKeyword.includes(':')) {
                highlightKeyword = currentSearchKeyword;
            }

            const txtKR = highlightText(item.content_kr, highlightKeyword);
            const txtEKR = highlightText(item.content_ekr ? item.content_ekr : '(ë°ì´í„° ì—†ìŒ)', highlightKeyword);
            const txtHR = highlightText(item.content_hr, highlightKeyword);
            const txtEN = highlightText(item.content_en, highlightKeyword);

            div.innerHTML = `
                <h3>${item.book} ${item.chapter}:${item.verse}</h3>
                <div class="verse-box">
                    <p class="verse-text kr">ğŸ‡°ğŸ‡· ${txtKR}</p>
                    <p class="verse-text ekr">ğŸ£ ${txtEKR}</p>
                    <p class="verse-text hr">ğŸ‡­ğŸ‡· ${txtHR}</p>
                    <p class="verse-text en">ğŸ‡ºğŸ‡¸ ${txtEN}</p>
                </div>
            `;
            resultContainer.appendChild(div);
        });
    }

    function setupPagination() {
        const paginationContainer = document.getElementById('pagination');
        paginationContainer.innerHTML = "";
        const pageCount = Math.ceil(currentFilteredData.length / rowsPerPage);
        if (pageCount <= 1) return;

        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(pageCount, startPage + 4);
        if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);

        for (let i = startPage; i <= endPage; i++) {
            const btn = document.createElement('button');
            btn.innerText = i;
            btn.className = 'page-btn';
            if (i === currentPage) btn.classList.add('active');
            btn.addEventListener('click', function() {
                currentPage = i;
                displayList(); 
                setupPagination(); 
            });
            paginationContainer.appendChild(btn);
        }
    }

    document.getElementById('searchInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') searchBible();
    });

    function openModal() { document.getElementById('helpModal').style.display = 'flex'; }
    function closeModal(event) { if (event.target.id === 'helpModal') document.getElementById('helpModal').style.display = 'none'; }
    function closeModalButton() { document.getElementById('helpModal').style.display = 'none'; }
</script>

</body>
</html>


